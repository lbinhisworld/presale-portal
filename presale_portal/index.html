<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>å”®å‰çŸ¥è¯†ç®¡ç†ç³»ç»Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'PingFang SC', 'Segoe UI', Arial, sans-serif;
      background: #f4f7fb;
      color: #1f2933;
    }
    .app {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 40px;
      background: #ffffff;
      box-shadow: 0 1px 4px rgba(15, 35, 95, 0.08);
    }
    .app-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .logo-box {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: linear-gradient(135deg, #2563eb, #4f46e5);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
    }
    .logo-box svg {
      width: 24px;
      height: 24px;
      fill: currentColor;
    }
    .title-main {
      font-size: 22px;
      font-weight: 700;
      color: #111827;
    }
    .title-sub {
      font-size: 13px;
      color: #6b7280;
      margin-top: 2px;
    }
    .app-header-right {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #6b7280;
      font-size: 13px;
    }
    .settings-icon {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    .settings-icon svg {
      width: 20px;
      height: 20px;
      fill: #6b7280;
    }
    .app-body {
      flex: 1;
      padding: 24px 40px 32px 40px;
    }
    .tip-banner {
      background: #eff6ff;
      border-radius: 12px;
      border: 1px solid #dbeafe;
      padding: 14px 18px;
      display: flex;
      gap: 12px;
      align-items: flex-start;
      margin-bottom: 22px;
    }
    .tip-icon {
      margin-top: 3px;
      color: #2563eb;
    }
    .tip-icon svg {
      width: 18px;
      height: 18px;
      fill: currentColor;
    }
    .tip-title {
      font-size: 14px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 4px;
    }
    .tip-text {
      font-size: 13px;
      line-height: 1.6;
      color: #4b5563;
    }
    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
      gap: 20px;
    }
    .card {
      background: #ffffff;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.03);
      padding: 20px 22px 22px 22px;
      display: flex;
      flex-direction: column;
    }
    .card-title {
      font-size: 18px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 4px;
    }
    .card-subtitle {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 16px;
    }
    .upload-area {
      flex: 1;
      border-radius: 16px;
      border: 1px dashed #cbd5f5;
      background: #f9fafb;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: background 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .upload-area:hover {
      background: #f3f4ff;
      border-color: #7c3aed;
      box-shadow: 0 6px 18px rgba(124, 58, 237, 0.14);
    }
    .upload-area.dragover {
      background: #eef2ff;
      border-color: #4f46e5;
    }
    .upload-icon {
      width: 60px;
      height: 60px;
      border-radius: 999px;
      background: #e0ecff;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
      color: #2563eb;
    }
    .upload-icon svg {
      width: 32px;
      height: 32px;
      fill: currentColor;
    }
    .upload-title {
      font-size: 18px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }
    .upload-desc {
      font-size: 13px;
      color: #4b5563;
      margin-bottom: 14px;
    }
    .upload-filetip {
      font-size: 12px;
      color: #6b7280;
    }
    .upload-filetip span {
      font-weight: 500;
      color: #111827;
    }
    .upload-button {
      margin-top: 18px;
      padding: 8px 18px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #2563eb, #4f46e5);
      color: #ffffff;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .upload-button:disabled {
      opacity: 0.7;
      cursor: default;
    }
    .upload-button svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }
    /* æå–æŒ‰é’®ç½‘æ ¼å¸ƒå±€ */
    .extract-buttons-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 16px;
      width: 100%;
    }
    .extract-button {
      padding: 14px 16px;
      border: none;
      border-radius: 12px;
      color: #ffffff;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      min-height: 90px;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .extract-button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    .extract-button:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .extract-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    .extract-button svg {
      width: 24px;
      height: 24px;
      fill: currentColor;
      flex-shrink: 0;
    }
    .extract-button span {
      text-align: center;
      line-height: 1.4;
      word-break: break-word;
    }
    .hidden-input {
      display: none;
    }
    .status-text {
      font-size: 13px;
      color: #6b7280;
      margin-top: 10px;
    }
    .status-text span {
      font-weight: 600;
      color: #111827;
    }
    .status-error span {
      color: #dc2626;
    }
    .result-placeholder {
      flex: 1;
      border-radius: 16px;
      background: #f9fafb;
      border: 1px dashed #e5e7eb;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 28px;
      text-align: center;
    }
    .result-icon {
      width: 56px;
      height: 56px;
      border-radius: 999px;
      background: #f3f4f6;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
      color: #9ca3af;
    }
    .result-icon svg {
      width: 28px;
      height: 28px;
      fill: currentColor;
    }
    .result-title {
      font-size: 17px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 6px;
    }
    .result-desc {
      font-size: 13px;
      color: #6b7280;
      max-width: 320px;
    }
    .result-sections {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 18px;
    }
    .result-card {
      background: #ffffff;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 10px 12px 12px 12px;
      font-size: 12px;
      text-align: left;
    }
    .result-card-title {
      font-size: 13px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .tag {
      padding: 1px 6px;
      border-radius: 999px;
      background: #eff6ff;
      color: #2563eb;
      font-size: 11px;
      font-weight: 500;
    }
    .result-card-content.empty {
      color: #9ca3af;
      font-style: italic;
    }
    .result-container {
      margin-top: 18px;
      width: 100%;
    }
    .result-section {
      margin-bottom: 24px;
      padding: 16px;
      background: #ffffff;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
    }
    .result-section-title {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e5e7eb;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .result-section-content {
      font-size: 13px;
      line-height: 1.8;
      color: #374151;
    }
    .result-section-content h3 {
      font-size: 14px;
      font-weight: 600;
      color: #111827;
      margin-top: 16px;
      margin-bottom: 8px;
    }
    .result-section-content h4 {
      font-size: 13px;
      font-weight: 600;
      color: #374151;
      margin-top: 12px;
      margin-bottom: 6px;
    }
    .result-section-content ul,
    .result-section-content ol {
      margin: 8px 0;
      padding-left: 24px;
    }
    .result-section-content li {
      margin: 4px 0;
    }
    .result-section-content table {
      width: 100%;
      border-collapse: collapse;
      margin: 12px 0;
      font-size: 12px;
    }
    .result-section-content table th,
    .result-section-content table td {
      padding: 8px 12px;
      text-align: left;
      border: 1px solid #e5e7eb;
    }
    .result-section-content table th {
      background: #f9fafb;
      font-weight: 600;
      color: #111827;
    }
    .result-section-content code {
      background: #f3f4f6;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
      font-size: 12px;
      color: #dc2626;
    }
    .result-section-content pre {
      background: #f9fafb;
      padding: 12px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 12px 0;
    }
    .result-section-content pre code {
      background: transparent;
      padding: 0;
      color: #374151;
    }
    /* ä¸šåŠ¡æ¶æ„æµç¨‹å¡ç‰‡æ ·å¼ */
    .process-card {
      background: #f9fafb;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      margin-bottom: 12px;
      overflow: hidden;
      transition: all 0.2s ease;
    }
    .process-card:hover {
      border-color: #d1d5db;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    .process-card-header {
      padding: 12px 16px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
    }
    .process-card-header:hover {
      background: #f9fafb;
    }
    .process-card-title {
      font-size: 14px;
      font-weight: 600;
      color: #111827;
      flex: 1;
    }
    .process-card-toggle {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6b7280;
      transition: transform 0.2s ease;
    }
    .process-card.expanded .process-card-toggle {
      transform: rotate(180deg);
    }
    .process-card-content {
      padding: 16px;
      display: none;
    }
    .process-card.expanded .process-card-content {
      display: block;
    }
    .process-field {
      margin-bottom: 12px;
    }
    .process-field:last-child {
      margin-bottom: 0;
    }
    .process-field-label {
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 4px;
      display: inline-block;
    }
    .process-field-value {
      font-size: 13px;
      color: #374151;
      line-height: 1.6;
    }
    .process-pain-point {
      background: #fef3c7;
      border: 1px solid #fde68a;
      border-radius: 6px;
      padding: 10px 12px;
      margin-top: 8px;
    }
    .process-pain-point-label {
      font-size: 12px;
      font-weight: 600;
      color: #92400e;
      margin-bottom: 4px;
    }
    .process-pain-point-value {
      font-size: 13px;
      color: #78350f;
      line-height: 1.6;
    }
    /* ç¯èŠ‚æ ·å¼ */
    .process-step {
      margin-bottom: 16px;
      padding-left: 20px;
      border-left: 2px solid #e5e7eb;
    }
    .process-step:last-child {
      margin-bottom: 0;
    }
    .process-step-item {
      margin-bottom: 8px;
    }
    .process-step-item:last-child {
      margin-bottom: 0;
    }
    .process-step-label {
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 4px;
      display: inline-block;
    }
    .process-step-value {
      font-size: 13px;
      color: #374151;
      line-height: 1.6;
    }
    /* é€šä¹‰åƒé—®é…ç½®å¼¹çª— */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal-backdrop.show {
      display: flex;
    }
    .modal {
      width: 420px;
      max-width: 90vw;
      background: #ffffff;
      border-radius: 14px;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.28);
      padding: 18px 20px 16px 20px;
    }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .modal-title {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
    }
    .modal-close {
      border: none;
      background: none;
      cursor: pointer;
      padding: 4px;
      color: #6b7280;
    }
    .modal-close svg {
      width: 18px;
      height: 18px;
      fill: currentColor;
    }
    .modal-body {
      font-size: 13px;
      color: #4b5563;
    }
    .modal-field-label {
      margin-top: 10px;
      margin-bottom: 4px;
      font-size: 13px;
      font-weight: 500;
      color: #111827;
    }
    .modal-input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 13px;
      font-family: inherit;
    }
    .modal-input:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px #2563eb22;
    }
    .modal-hint {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }
    .modal-footer {
      margin-top: 14px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      font-size: 13px;
    }
    .btn {
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid transparent;
      cursor: pointer;
      font-size: 13px;
      font-family: inherit;
    }
    .btn-secondary {
      background: #f3f4f6;
      border-color: #e5e7eb;
      color: #374151;
    }
    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #4f46e5);
      color: #ffffff;
    }
    .config-status {
      font-size: 12px;
      color: #059669;
      margin-top: 4px;
      text-align: right;
      min-height: 16px;
    }
    @media (max-width: 960px) {
      .app-body {
        padding: 18px 16px 24px 16px;
      }
      .app-header {
        padding: 14px 16px;
      }
      .layout {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div class="app-header-left">
        <div class="logo-box">
          <svg viewBox="0 0 24 24">
            <path d="M4 5a2 2 0 0 1 2-2h9.5a2 2 0 0 1 1.4.58l3.5 3.5A2 2 0 0 1 21 8.5V19a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V5z"/>
          </svg>
        </div>
        <div>
          <div class="title-main">å”®å‰çŸ¥è¯†ç®¡ç†ç³»ç»Ÿ</div>
          <div class="title-sub">AI é©±åŠ¨çš„è¡Œä¸š Know-how æå–å¹³å°</div>
        </div>
      </div>
      <div class="app-header-right">
        <button id="openQwenConfig" class="btn btn-secondary" style="padding:4px 10px;border-radius:999px;">
          é€šä¹‰åƒé—®é…ç½®
        </button>
        <div class="settings-icon" id="openQwenConfigIcon">
          <svg viewBox="0 0 24 24">
            <path d="M19.14,12.94a7.43,7.43,0,0,0,.05-.94,7.43,7.43,0,0,0-.05-.94l2-1.55a.5.5,0,0,0,.12-.63l-1.9-3.29a.5.5,0,0,0-.61-.22l-2.35,1a7.28,7.28,0,0,0-1.63-.94l-.36-2.49A.5.5,0,0,0,13,2H11a.5.5,0,0,0-.5.42L10.14,4.91a7.28,7.28,0,0,0-1.63.94l-2.35-1a.5.5,0,0,0-.61.22L3.65,8.36a.5.5,0,0,0,.12.63l2,1.55a7.43,7.43,0,0,0-.05.94,7.43,7.43,0,0,0,.05.94l-2,1.55a.5.5,0,0,0-.12.63l1.9,3.29a.5.5,0,0,0,.61.22l2.35-1a7.28,7.28,0,0,0,1.63.94l.36,2.49A.5.5,0,0,0,11,22h2a.5.5,0,0,0,.5-.42l.36-2.49a7.28,7.28,0,0,0,1.63-.94l2.35,1a.5.5,0,0,0,.61-.22l1.9-3.29a.5.5,0,0,0-.12-.63ZM12,15.5A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z"/>
          </svg>
        </div>
      </div>
    </header>

    <main class="app-body">
      <section class="tip-banner">
        <div class="tip-icon">
          <svg viewBox="0 0 24 24">
            <path d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Zm0 15a1.25 1.25 0 1 1 1.25-1.25A1.25 1.25 0 0 1 12 17Zm1-4.5a1 1 0 0 1-2 0V8a1 1 0 0 1 2 0Z"/>
          </svg>
        </div>
        <div>
          <div class="tip-title">ä½¿ç”¨è¯´æ˜</div>
          <div class="tip-text">
            ä¸Šä¼ å·²äº¤ä»˜é¡¹ç›®çš„å®æ–½è§„åˆ’è“å›¾ PDF æ–‡æ¡£ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æå–ä¸šåŠ¡åœºæ™¯ã€ç®¡ç†æœºåˆ¶ã€æ•°æ®æ²»ç†å’Œç—›ç‚¹å¯¹ç­–ç­‰å…³é”®ä¿¡æ¯ï¼Œ
            å½¢æˆå¯å¤ç”¨çš„è¡Œä¸šçŸ¥è¯†åº“ã€‚
          </div>
        </div>
      </section>

      <section class="layout">
        <!-- ä¸Šä¼ æ–‡æ¡£ -->
        <div class="card">
          <div class="card-title">ä¸Šä¼ æ–‡æ¡£</div>
          <div class="card-subtitle">ä¸Šä¼ é¡¹ç›®è“å›¾ PDFï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è¿›è¡Œè¯†åˆ«ä¸è¦ç‚¹æå–ã€‚</div>
          <input
            id="blueprintFileInput"
            class="hidden-input"
            type="file"
            accept="application/pdf"
          />
          <div id="uploadArea" class="upload-area">
            <div class="upload-icon">
              <svg viewBox="0 0 24 24">
                <path d="M12 3l4 4h-3v6h-2V7H8l4-4Zm7 9v7H5v-7H3v7a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7h-2Z"/>
              </svg>
            </div>
            <div class="upload-title">ä¸Šä¼ é¡¹ç›®è“å›¾</div>
            <div class="upload-desc">æ‹–æ‹½ PDF æ–‡ä»¶åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶ã€‚</div>
            <div class="upload-filetip">
              <span>æ”¯æŒ PDF æ ¼å¼</span>ï¼Œå•ä¸ªæ–‡ä»¶ä¸è¶…è¿‡ 30 MBã€‚
            </div>
            <div id="selectedFileName" class="selected-file-name" style="display: none; margin-top: 16px; padding: 10px 14px; background: #f0f9ff; border-radius: 8px; border: 1px solid #bae6fd; font-size: 13px; color: #0369a1;">
              <svg style="width: 16px; height: 16px; vertical-align: middle; margin-right: 6px; fill: #0369a1;" viewBox="0 0 24 24">
                <path d="M4 5a2 2 0 0 1 2-2h9.5a2 2 0 0 1 1.4.58l3.5 3.5A2 2 0 0 1 21 8.5V19a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V5z"/>
              </svg>
              <span id="fileNameText"></span>
            </div>
            <button id="blueprintAnalyzeBtn" class="upload-button">
              <svg viewBox="0 0 24 24">
                <path d="M5 4h14v2H5zm0 5h10v2H5zm0 5h14v2H5z"/>
              </svg>
              å¼€å§‹è¯†åˆ«
            </button>
            <div class="extract-buttons-grid">
              <button id="projectOverviewBtn" class="extract-button" style="background: linear-gradient(135deg, #059669, #047857);">
                <svg viewBox="0 0 24 24">
                  <path d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2zm0 15a1 1 0 1 1 1-1 1 1 0 0 1-1 1zm1-4h-2V7h2Z"/>
                </svg>
                <span>é¡¹ç›®èƒŒæ™¯æ¦‚è§ˆ</span>
              </button>
              <button id="businessArchitectureBtn" class="extract-button" style="background: linear-gradient(135deg, #7c3aed, #6d28d9);">
                <svg viewBox="0 0 24 24">
                  <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
                <span>ä¸šåŠ¡æ¶æ„å±‚</span>
              </button>
              <button id="roleValueTransformationBtn" class="extract-button" style="background: linear-gradient(135deg, #dc2626, #b91c1c);">
                <svg viewBox="0 0 24 24">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
                <span>è§’è‰²ä»·å€¼è½¬æ¢å±‚</span>
              </button>
              <button id="painPointsBtn" class="extract-button" style="background: linear-gradient(135deg, #ea580c, #c2410c);">
                <svg viewBox="0 0 24 24">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                </svg>
                <span>éœ€æ±‚ç—›ç‚¹å±‚</span>
              </button>
              <button id="itArchitectureBtn" class="extract-button" style="background: linear-gradient(135deg, #0891b2, #0e7490);">
                <svg viewBox="0 0 24 24">
                  <path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z"/>
                </svg>
                <span>IT æ¶æ„ä¸é›†æˆå±‚</span>
              </button>
              <button id="solutionStrategyBtn" class="extract-button" style="background: linear-gradient(135deg, #059669, #047857);">
                <svg viewBox="0 0 24 24">
                  <path d="M9 11.24V7.5a2.5 2.5 0 0 1 5 0v3.74c1.21-.81 2-2.18 2-3.74C16 5.01 13.99 3 11.5 3S7 5.01 7 7.5c0 1.56.79 2.93 2 3.74zm9.84 4.63l-4.54-2.26c-.17-.07-.35-.11-.54-.11H13v-6c0-.83-.67-1.5-1.5-1.5S10 6.67 10 7.5v10.74l-3.43-.72c-.08-.01-.15-.03-.24-.03-.31 0-.59.13-.79.33l-.79.8 4.94 4.94c.27.27.65.44 1.06.44h6.79c.75 0 1.33-.55 1.44-1.28l.75-5.27c.01-.07.02-.14.02-.2 0-.62-.38-1.16-.91-1.38z"/>
                </svg>
                <span>æ–¹æ¡ˆç­–ç•¥å±‚</span>
              </button>
              <button id="changeManagementBtn" class="extract-button" style="background: linear-gradient(135deg, #7c2d12, #6b1f0e);">
                <svg viewBox="0 0 24 24">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
                <span>å˜é©ç®¡ç†å±‚</span>
              </button>
              <button id="assetSchedulingBtn" class="extract-button" style="background: linear-gradient(135deg, #1e40af, #1e3a8a);">
                <svg viewBox="0 0 24 24">
                  <path d="M20 6h-2.18c.11-.31.18-.65.18-1a2.996 2.996 0 0 0-5.5-1.65l-.5.67-.5-.68C10.96 2.54 10 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 11 8.76l1-1.36 1 1.36L15.38 12 17 10.83 14.92 8H20v6z"/>
                </svg>
                <span>èµ„äº§ä¸èµ„æºè°ƒåº¦å±‚</span>
              </button>
              <button id="standardsBtn" class="extract-button" style="background: linear-gradient(135deg, #4338ca, #3730a3);">
                <svg viewBox="0 0 24 24">
                  <path d="M9 11.24V7.5a2.5 2.5 0 0 1 5 0v3.74c1.21-.81 2-2.18 2-3.74C16 5.01 13.99 3 11.5 3S7 5.01 7 7.5c0 1.56.79 2.93 2 3.74zm9.84 4.63l-4.54-2.26c-.17-.07-.35-.11-.54-.11H13v-6c0-.83-.67-1.5-1.5-1.5S10 6.67 10 7.5v10.74l-3.43-.72c-.08-.01-.15-.03-.24-.03-.31 0-.59.13-.79.33l-.79.8 4.94 4.94c.27.27.65.44 1.06.44h6.79c.75 0 1.33-.55 1.44-1.28l.75-5.27c.01-.07.02-.14.02-.2 0-.62-.38-1.16-.91-1.38z"/>
                </svg>
                <span>è¡Œä¸šè§„èŒƒä¸æ ‡å‡†åŒ–å±‚</span>
              </button>
              <button id="industryAssetsBtn" class="extract-button" style="background: linear-gradient(135deg, #be185d, #9f1239);">
                <svg viewBox="0 0 24 24">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
                <span>è¡Œä¸šèµ„äº§æ€»ç»“å±‚</span>
              </button>
            </div>
            <div id="recognitionProcess" class="recognition-process" style="display: none; margin-top: 16px; padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb; max-height: 200px; overflow-y: auto;">
              <div style="font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 8px;">è¯†åˆ«è¿‡ç¨‹ï¼š</div>
              <textarea id="recognitionProcessText" readonly style="width: 100%; min-height: 120px; border: none; background: transparent; font-size: 12px; color: #4b5563; line-height: 1.6; font-family: 'Monaco', 'Menlo', 'Courier New', monospace; resize: none; outline: none;"></textarea>
            </div>
            <div id="blueprintStatus" class="status-text">
              å½“å‰çŠ¶æ€ï¼š<span>ç­‰å¾…ä¸Šä¼ å®æ–½è“å›¾</span>
            </div>
          </div>
        </div>

        <!-- åˆ†æç»“æœ -->
        <div class="card">
          <div class="card-title">åˆ†æç»“æœ</div>
          <div class="card-subtitle">ä¸Šä¼ é¡¹ç›®è“å›¾åï¼ŒAI å°†æ·±åº¦æç‚¼9ä¸ªç»´åº¦çš„è¡Œä¸šçŸ¥è¯†èµ„äº§ï¼Œæ„å»ºå¯å¤ç”¨çš„çŸ¥è¯†åº“ã€‚</div>
          <div class="result-placeholder">
            <div class="result-icon">
              <svg viewBox="0 0 24 24">
                <path d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Zm0 15a1 1 0 1 1 1-1 1 1 0 0 1-1 1Zm1-4h-2V7h2Z"/>
              </svg>
            </div>
            <div class="result-title">ç­‰å¾…ä¸Šä¼ </div>
            <div class="result-desc">
              ä¸Šä¼ é¡¹ç›®è“å›¾åï¼Œç³»ç»Ÿå°†æ·±åº¦æç‚¼è¡Œä¸šçŸ¥è¯†èµ„äº§ï¼ŒåŒ…æ‹¬é¡¹ç›®èƒŒæ™¯ã€ä¸šåŠ¡æ¶æ„ã€è§’è‰²ä»·å€¼è½¬æ¢ã€éœ€æ±‚ç—›ç‚¹ã€æ–¹æ¡ˆç­–ç•¥ã€å˜é©ç®¡ç†ã€èµ„æºè°ƒåº¦ã€è¡Œä¸šè§„èŒƒå’Œæ ¸å¿ƒèµ„äº§ç­‰9ä¸ªç»´åº¦ï¼Œå¸®åŠ©æ„å»ºå…¬å¸çº§è¡Œä¸šçŸ¥è¯†åº“ã€‚
            </div>
                </div>
          <div id="resultContainer" class="result-container" style="display: none;">
            <!-- ç»“æœå†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- é€šä¹‰åƒé—® Secret é…ç½®å¼¹çª— -->
  <div id="qwenModalBackdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">é€šä¹‰åƒé—® Secret é…ç½®</div>
        <button id="closeQwenConfig" class="modal-close">
          <svg viewBox="0 0 24 24">
            <path d="M18.3 5.71a1 1 0 0 0-1.41 0L12 10.59 7.11 5.7A1 1 0 0 0 5.7 7.11L10.59 12 5.7 16.89a1 1 0 1 0 1.41 1.41L12 13.41l4.89 4.89a1 1 0 0 0 1.41-1.41L13.41 12l4.89-4.89a1 1 0 0 0 0-1.4Z"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="modal-field-label">åƒé—® API Secret Key</div>
        <input
          id="qwenSecretInput"
          class="modal-input"
          type="password"
          placeholder="ä¾‹å¦‚ï¼šsk-xxxxxxxxxxxxxxxx"
        />
        <div class="modal-hint">
          è¯´æ˜ï¼šæ­¤ Secret ä»…ä¿å­˜åœ¨å½“å‰æµè§ˆå™¨ï¼ˆlocalStorageï¼‰ï¼Œç”¨äºè°ƒç”¨åç«¯æ—¶æºå¸¦åƒé—®é…ç½®ï¼Œå»ºè®®ä½¿ç”¨æµ‹è¯•ç¯å¢ƒå¯†é’¥ã€‚
        </div>
        <div id="qwenConfigStatus" class="config-status"></div>
      </div>
      <div class="modal-footer">
        <button id="clearQwenConfig" class="btn btn-secondary">æ¸…é™¤é…ç½®</button>
        <button id="saveQwenConfig" class="btn btn-primary">ä¿å­˜</button>
      </div>
    </div>
  </div>
  <script>
    (function () {
      const fileInput = document.getElementById('blueprintFileInput');
      const analyzeBtn = document.getElementById('blueprintAnalyzeBtn');
      const projectOverviewBtn = document.getElementById('projectOverviewBtn');
      const statusEl = document.getElementById('blueprintStatus');
      const uploadArea = document.getElementById('uploadArea');
      let resultPlaceholder = document.querySelector('.result-placeholder');
      let resultContainer = document.getElementById('resultContainer');
      const selectedFileNameEl = document.getElementById('selectedFileName');
      const fileNameTextEl = document.getElementById('fileNameText');
      const recognitionProcessEl = document.getElementById('recognitionProcess');
      const recognitionProcessTextEl = document.getElementById('recognitionProcessText');
      // é€šä¹‰åƒé—®é…ç½®ç›¸å…³å…ƒç´ 
      const openQwenBtn = document.getElementById('openQwenConfig');
      const openQwenIcon = document.getElementById('openQwenConfigIcon');
      const qwenModalBackdrop = document.getElementById('qwenModalBackdrop');
      const closeQwenBtn = document.getElementById('closeQwenConfig');
      const qwenSecretInput = document.getElementById('qwenSecretInput');
      const saveQwenBtn = document.getElementById('saveQwenConfig');
      const clearQwenBtn = document.getElementById('clearQwenConfig');
      const qwenConfigStatus = document.getElementById('qwenConfigStatus');

      const MAX_SIZE_MB = 30;
      const QWEN_SECRET_KEY = 'preSales_qwen_secret';

      function log(level, message, detail) {
        const time = new Date().toISOString();
        const payload = { time, level, message };
        if (detail !== undefined) {
          payload.detail = detail;
        }
        // æ ¼å¼åŒ–ä¸ºå¯è¯»çš„å­—ç¬¦ä¸²
        const logMessage = `[PreSales] [${level.toUpperCase()}] ${message}${detail ? ' | ' + JSON.stringify(detail) : ''}`;
        if (level === 'error') {
          console.error(logMessage, payload);
        } else if (level === 'warn') {
          console.warn(logMessage, payload);
        } else {
          console.log(logMessage, payload);
        }
      }

      function setStatus(text, isError) {
        if (!statusEl) return;
        const span = statusEl.querySelector('span');
        if (span) {
          span.textContent = text;
          span.style.color = isError ? '#C0392B' : '#1A5276';
          if (isError) {
            statusEl.classList.add('status-error');
          } else {
            statusEl.classList.remove('status-error');
          }
        }
      }

      function setLoading(loading) {
        if (!analyzeBtn) return;
        analyzeBtn.disabled = loading;
        analyzeBtn.textContent = loading ? 'æ­£åœ¨è¯†åˆ«...' : 'å¼€å§‹è¯†åˆ«';
      }

      function showFileName(fileName) {
        if (selectedFileNameEl && fileNameTextEl) {
          selectedFileNameEl.style.display = 'block';
          fileNameTextEl.textContent = fileName || 'æœªçŸ¥æ–‡ä»¶';
        }
      }

      function hideFileName() {
        if (selectedFileNameEl) {
          selectedFileNameEl.style.display = 'none';
        }
      }

      function showRecognitionProcess() {
        if (recognitionProcessEl) {
          recognitionProcessEl.style.display = 'block';
        }
        if (recognitionProcessTextEl) {
          recognitionProcessTextEl.value = '';
        }
      }

      function hideRecognitionProcess() {
        if (recognitionProcessEl) {
          recognitionProcessEl.style.display = 'none';
        }
      }

      function appendRecognitionProcess(text) {
        if (recognitionProcessTextEl) {
          // ç¡®ä¿textæ˜¯å­—ç¬¦ä¸²
          const textStr = typeof text === 'string' ? text : (text ? String(text) : '');
          recognitionProcessTextEl.value += textStr;
          // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
          recognitionProcessTextEl.scrollTop = recognitionProcessTextEl.scrollHeight;
        }
      }

      function maskSecret(secret) {
        if (!secret) return '';
        if (secret.length <= 6) return '****';
        return secret.slice(0, 3) + '****' + secret.slice(-3);
      }

      // ç®€å•çš„Markdownè½¬HTMLå‡½æ•°
      function markdownToHtml(text) {
        if (!text || typeof text !== 'string') return '<p style="color: #9ca3af; font-style: italic;">æœªæå–</p>';
        if (!text.trim()) return '<p style="color: #9ca3af; font-style: italic;">æœªæå–</p>';
        
        let html = text.trim();
        
        // å¤„ç†ä»£ç å—
        html = html.replace(/```([^`]+)```/g, '<pre><code>$1</code></pre>');
        
        // å¤„ç†è¡Œå†…ä»£ç 
        html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
        
        // å¤„ç†æ ‡é¢˜
        html = html.replace(/^#### (.*$)/gim, '<h4>$1</h4>');
        html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
        html = html.replace(/^## (.*$)/gim, '<h3>$1</h3>');
        html = html.replace(/^# (.*$)/gim, '<h2>$1</h2>');
        
        // å¤„ç†åˆ—è¡¨ï¼šå…ˆæŒ‰è¡Œåˆ†å‰²ï¼Œè¯†åˆ«åˆ—è¡¨é¡¹
        const lines = html.split('\n');
        const processedLines = [];
        let inList = false;
        
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          // åŒ¹é…æ— åºåˆ—è¡¨ï¼ˆ- æˆ– * å¼€å¤´ï¼Œåé¢è·Ÿç©ºæ ¼ï¼‰
          const listMatch = line.match(/^[-*]\s+(.+)$/);
          // åŒ¹é…æœ‰åºåˆ—è¡¨ï¼ˆæ•°å­—. å¼€å¤´ï¼‰
          const orderedMatch = line.match(/^(\d+)\.\s+(.+)$/);
          
          if (listMatch || orderedMatch) {
            const content = listMatch ? listMatch[1] : orderedMatch[2];
            if (!inList) {
              processedLines.push('<ul>');
              inList = true;
            }
            processedLines.push('<li>' + content.trim() + '</li>');
          } else {
            if (inList) {
              processedLines.push('</ul>');
              inList = false;
            }
            if (line.trim()) {
              processedLines.push(line);
            }
          }
        }
        
        if (inList) {
          processedLines.push('</ul>');
        }
        
        html = processedLines.join('\n');
        
        // å¤„ç†æ¢è¡Œ
        html = html.replace(/\n\n+/g, '</p><p>');
        html = '<p>' + html + '</p>';
        html = html.replace(/<p><\/p>/g, '');
        html = html.replace(/<p>(<h[234]>)/g, '$1');
        html = html.replace(/(<\/h[234]>)<\/p>/g, '$1');
        html = html.replace(/<p>(<ul>)/g, '$1');
        html = html.replace(/(<\/ul>)<\/p>/g, '$1');
        html = html.replace(/<p>(<pre>)/g, '$1');
        html = html.replace(/(<\/pre>)<\/p>/g, '$1');
        
        // å¤„ç†å•è¡Œæ¢è¡Œï¼ˆä¸åœ¨åˆ—è¡¨æ ‡ç­¾å†…çš„æ¢è¡Œï¼‰
        html = html.replace(/\n/g, function(match, offset, str) {
          // æ£€æŸ¥å‰åæ˜¯å¦æ˜¯åˆ—è¡¨æ ‡ç­¾
          const before = str.substring(Math.max(0, offset - 10), offset);
          const after = str.substring(offset + 1, Math.min(str.length, offset + 11));
          if (before.includes('</li>') || after.includes('<li>') || before.includes('</ul>') || after.includes('<ul>')) {
            return ' '; // åˆ—è¡¨å†…çš„æ¢è¡Œè½¬ä¸ºç©ºæ ¼
          }
          return '<br>';
        });
        
        return html;
      }

      // è§£æä¸šåŠ¡æ¶æ„å±‚æ–‡æœ¬ï¼Œæå–æµç¨‹ä¿¡æ¯
      function parseBusinessArchitecture(text) {
        if (!text || typeof text !== 'string') return [];
        
        const processes = [];
        const lines = text.split('\n');
        let currentProcess = null;
        let currentStep = null;
        
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;
          
          // åŒ¹é…æµç¨‹æ ‡é¢˜ï¼šæµç¨‹ [ç¼–å·]ï¼š[åç§°] æˆ– æµç¨‹[ç¼–å·]ï¼š[åç§°]
          const processMatch = line.match(/æµç¨‹\s*([\d.]+)[ï¼š:]\s*(.+)/);
          if (processMatch) {
            // ä¿å­˜ä¸Šä¸€ä¸ªæµç¨‹
            if (currentProcess) {
              if (currentStep) {
                currentProcess.steps.push(currentStep);
                currentStep = null;
              }
              processes.push(currentProcess);
            }
            // åˆ›å»ºæ–°æµç¨‹
            currentProcess = {
              number: processMatch[1],
              name: processMatch[2],
              steps: []
            };
            continue;
          }
          
          if (currentProcess) {
            // åŒ¹é…ç¯èŠ‚åç§° - è¿™è¡¨ç¤ºä¸€ä¸ªæ–°ç¯èŠ‚çš„å¼€å§‹
            if (line.match(/ç¯èŠ‚åç§°[ï¼š:]/i)) {
              // ä¿å­˜ä¸Šä¸€ä¸ªç¯èŠ‚
              if (currentStep) {
                currentProcess.steps.push(currentStep);
              }
              // åˆ›å»ºæ–°ç¯èŠ‚
              currentStep = {
                stepName: line.replace(/ç¯èŠ‚åç§°[ï¼š:]\s*/i, '').trim(),
                role: '',
                workContent: ''
              };
              continue;
            }
            
            // å¦‚æœè¿˜æ²¡æœ‰ç¯èŠ‚ï¼Œä½†é‡åˆ°äº†æ‰§è¡Œè§’è‰²æˆ–å·¥ä½œå†…å®¹ï¼Œåˆ›å»ºä¸€ä¸ªé»˜è®¤ç¯èŠ‚
            if (!currentStep && (line.match(/æ‰§è¡Œè§’è‰²[ï¼š:]|å·¥ä½œå†…å®¹[ï¼š:]/i))) {
              currentStep = {
                stepName: '',
                role: '',
                workContent: ''
              };
            }
            
            if (currentStep) {
              // åŒ¹é…æ‰§è¡Œè§’è‰²
              if (line.match(/æ‰§è¡Œè§’è‰²[ï¼š:]/i)) {
                currentStep.role = line.replace(/æ‰§è¡Œè§’è‰²[ï¼š:]\s*/i, '').trim();
                continue;
              }
              
              // åŒ¹é…å·¥ä½œå†…å®¹ï¼ˆå¯èƒ½æ˜¯å¤šè¡Œï¼‰
              if (line.match(/å·¥ä½œå†…å®¹[ï¼š:]/i)) {
                currentStep.workContent = line.replace(/å·¥ä½œå†…å®¹[ï¼š:]\s*/i, '').trim();
                // ç»§ç»­è¯»å–åç»­è¡Œç›´åˆ°é‡åˆ°ä¸‹ä¸€ä¸ªå­—æ®µæˆ–æµç¨‹
                let j = i + 1;
                while (j < lines.length) {
                  const nextLine = lines[j].trim();
                  if (!nextLine) {
                    j++;
                    continue;
                  }
                  if (nextLine.match(/ç¯èŠ‚åç§°[ï¼š:]|æ‰§è¡Œè§’è‰²[ï¼š:]|æµè½¬æ¡ä»¶[ï¼š:]|æ½œåœ¨ç—›ç‚¹[ï¼š:]|æµç¨‹\s*[\d.]+/i)) {
                    break;
                  }
                  if (currentStep.workContent) {
                    currentStep.workContent += ' ' + nextLine;
                  } else {
                    currentStep.workContent = nextLine;
                  }
                  j++;
                }
                i = j - 1;
                continue;
              }
            }
            
            // åŒ¹é…æµè½¬æ¡ä»¶ï¼ˆæµç¨‹çº§åˆ«çš„ï¼Œä¸æ˜¯ç¯èŠ‚çº§åˆ«çš„ï¼‰
            if (line.match(/æµè½¬æ¡ä»¶[ï¼š:]/i)) {
              // å…ˆä¿å­˜å½“å‰ç¯èŠ‚
              if (currentStep) {
                currentProcess.steps.push(currentStep);
                currentStep = null;
              }
              currentProcess.transitionCondition = line.replace(/æµè½¬æ¡ä»¶[ï¼š:]\s*/i, '').trim();
              // ç»§ç»­è¯»å–åç»­è¡Œç›´åˆ°é‡åˆ°ä¸‹ä¸€ä¸ªå­—æ®µæˆ–æµç¨‹
              let j = i + 1;
              while (j < lines.length) {
                const nextLine = lines[j].trim();
                if (!nextLine) {
                  j++;
                  continue;
                }
                if (nextLine.match(/æ½œåœ¨ç—›ç‚¹[ï¼š:]|æµç¨‹\s*[\d.]+/i)) {
                  break;
                }
                if (currentProcess.transitionCondition) {
                  currentProcess.transitionCondition += ' ' + nextLine;
                } else {
                  currentProcess.transitionCondition = nextLine;
                }
                j++;
              }
              i = j - 1;
              continue;
            }
            
            // åŒ¹é…æ½œåœ¨ç—›ç‚¹ï¼ˆæµç¨‹çº§åˆ«çš„ï¼‰
            if (line.match(/æ½œåœ¨ç—›ç‚¹[ï¼š:]/i)) {
              // å…ˆä¿å­˜å½“å‰ç¯èŠ‚
              if (currentStep) {
                currentProcess.steps.push(currentStep);
                currentStep = null;
              }
              currentProcess.painPoint = line.replace(/æ½œåœ¨ç—›ç‚¹[ï¼š:]\s*/i, '').trim();
              // ç»§ç»­è¯»å–åç»­è¡Œç›´åˆ°é‡åˆ°ä¸‹ä¸€ä¸ªæµç¨‹
              let j = i + 1;
              while (j < lines.length) {
                const nextLine = lines[j].trim();
                if (!nextLine) {
                  j++;
                  continue;
                }
                if (nextLine.match(/æµç¨‹\s*[\d.]+/i)) {
                  break;
                }
                if (currentProcess.painPoint) {
                  currentProcess.painPoint += ' ' + nextLine;
                } else {
                  currentProcess.painPoint = nextLine;
                }
                j++;
              }
              i = j - 1;
              continue;
            }
            
            // å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°ä»»ä½•å­—æ®µï¼Œå¯èƒ½æ˜¯å½“å‰å­—æ®µçš„ç»­è¡Œ
            if (currentStep) {
              if (currentStep.workContent) {
                currentStep.workContent += ' ' + line;
              } else if (currentStep.role) {
                // å¦‚æœå·²ç»æœ‰è§’è‰²ï¼Œä½†è¿˜æ²¡æœ‰å·¥ä½œå†…å®¹ï¼Œå¯èƒ½æ˜¯è§’è‰²çš„ç»­è¡Œ
                currentStep.role += ' ' + line;
              } else if (currentStep.stepName) {
                // å¦‚æœå·²ç»æœ‰ç¯èŠ‚åç§°ï¼Œä½†è¿˜æ²¡æœ‰è§’è‰²ï¼Œå¯èƒ½æ˜¯ç¯èŠ‚åç§°çš„ç»­è¡Œ
                currentStep.stepName += ' ' + line;
              }
            } else if (currentProcess.painPoint) {
              currentProcess.painPoint += ' ' + line;
            } else if (currentProcess.transitionCondition) {
              currentProcess.transitionCondition += ' ' + line;
            }
          }
        }
        
        // ä¿å­˜æœ€åä¸€ä¸ªæµç¨‹å’Œç¯èŠ‚
        if (currentProcess) {
          if (currentStep) {
            currentProcess.steps.push(currentStep);
          }
          processes.push(currentProcess);
        }
        
        return processes;
      }

      function clearResults() {
        if (resultContainer) {
          resultContainer.innerHTML = '';
          resultContainer.style.display = 'none';
        }
        if (resultPlaceholder) {
          resultPlaceholder.style.display = 'flex';
        }
      }

      function renderResults(data) {
        console.log('[DEBUG] renderResults called with data:', data);
        console.log('[DEBUG] resultContainer element:', resultContainer);
        console.log('[DEBUG] resultPlaceholder element:', resultPlaceholder);
        
        log('info', 'render-results-start', { 
          hasData: !!data, 
          hasContainer: !!resultContainer, 
          hasPlaceholder: !!resultPlaceholder,
          dataType: typeof data,
          dataKeys: data ? Object.keys(data) : []
        });
        
        // ç¡®ä¿å…ƒç´ å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™é‡æ–°è·å–
        if (!resultContainer) {
          console.warn('[DEBUG] resultContainer not found, retrying...');
          resultContainer = document.getElementById('resultContainer');
        }
        if (!resultPlaceholder) {
          console.warn('[DEBUG] resultPlaceholder not found, retrying...');
          resultPlaceholder = document.querySelector('.result-placeholder');
        }
        
        if (!resultContainer) {
          console.error('[DEBUG] resultContainer still not found after retry!');
          log('error', 'result-container-not-found');
          setStatus('æ— æ³•æ‰¾åˆ°ç»“æœå®¹å™¨å…ƒç´ ', true);
          return;
        }
        if (!resultPlaceholder) {
          console.warn('[DEBUG] resultPlaceholder not found!');
          log('warn', 'result-placeholder-not-found');
        }
        
        console.log('[DEBUG] Hiding placeholder, showing container');
        if (resultPlaceholder) {
          resultPlaceholder.style.display = 'none';
        }
        resultContainer.style.display = 'block';
        resultContainer.innerHTML = '';
        
        console.log('[DEBUG] Container display style:', resultContainer.style.display);
        console.log('[DEBUG] Container computed display:', window.getComputedStyle(resultContainer).display);

        const sections = [
          {
            title: 'ä¸€ã€é¡¹ç›®èƒŒæ™¯æ¦‚è§ˆ',
            icon: 'ğŸ“‹',
            content: (data.projectOverview && typeof data.projectOverview === 'object' && Object.keys(data.projectOverview).length > 0) ? `
              <h4>å®¢æˆ·åç§°</h4>
              <p>${(data.projectOverview.customerName && typeof data.projectOverview.customerName === 'string' && data.projectOverview.customerName.trim()) || 'æœªæå–'}</p>
              <h4>æ ¸å¿ƒé—®é¢˜</h4>
              ${(data.projectOverview.coreProblems && typeof data.projectOverview.coreProblems === 'string' && data.projectOverview.coreProblems.trim()) ? markdownToHtml(data.projectOverview.coreProblems) : '<p>æœªæå–</p>'}
              <h4>è§£å†³æ–¹æ¡ˆå°ç»“</h4>
              ${(data.projectOverview.solutionSummary && typeof data.projectOverview.solutionSummary === 'string' && data.projectOverview.solutionSummary.trim()) ? markdownToHtml(data.projectOverview.solutionSummary) : '<p>æœªæå–</p>'}
            ` : '<p style="color: #9ca3af; font-style: italic;">æœªæå–ï¼ˆæ•°æ®ç»“æ„ä¸ºç©ºï¼‰</p>'
          },
          {
            title: 'äºŒã€ä¸šåŠ¡æ¶æ„å±‚',
            icon: 'ğŸ—ï¸',
            content: (() => {
              const businessArchitecture = data.businessArchitecture;
              if (businessArchitecture && typeof businessArchitecture === 'string' && businessArchitecture.trim()) {
                const processes = parseBusinessArchitecture(businessArchitecture);
                if (processes.length > 0) {
                  return processes.map((process, index) => {
                    const processId = `process-main-${index}`;
                    // æ¸²æŸ“ç¯èŠ‚åˆ—è¡¨
                    const stepsHtml = process.steps && process.steps.length > 0 ? process.steps.map((step, stepIndex) => {
                      return `
                        <div class="process-step">
                          ${step.stepName ? `
                            <div class="process-step-item">
                              <div class="process-step-label">ç¯èŠ‚åç§°</div>
                              <div class="process-step-value">${step.stepName}</div>
                            </div>
                          ` : ''}
                          ${step.role ? `
                            <div class="process-step-item">
                              <div class="process-step-label">æ‰§è¡Œè§’è‰²</div>
                              <div class="process-step-value">${step.role}</div>
                            </div>
                          ` : ''}
                          ${step.workContent ? `
                            <div class="process-step-item">
                              <div class="process-step-label">å·¥ä½œå†…å®¹</div>
                              <div class="process-step-value">${markdownToHtml(step.workContent)}</div>
                            </div>
                          ` : ''}
                        </div>
                      `;
                    }).join('') : '<p style="color: #9ca3af; font-style: italic; padding-left: 20px;">æš‚æ— ç¯èŠ‚ä¿¡æ¯</p>';
                    
                    return `
                      <div class="process-card" id="${processId}">
                        <div class="process-card-header" onclick="this.parentElement.classList.toggle('expanded')">
                          <div class="process-card-title">æµç¨‹ ${process.number} ${process.name}</div>
                          <div class="process-card-toggle">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="M6 9l6 6 6-6"/>
                            </svg>
                          </div>
                        </div>
                        <div class="process-card-content">
                          ${stepsHtml}
                          ${process.transitionCondition ? `
                            <div class="process-field" style="margin-top: 16px;">
                              <div class="process-field-label">æµè½¬æ¡ä»¶</div>
                              <div class="process-field-value">${process.transitionCondition}</div>
                            </div>
                          ` : ''}
                          ${process.painPoint ? `
                            <div class="process-pain-point" style="margin-top: 16px;">
                              <div class="process-pain-point-label">æ½œåœ¨ç—›ç‚¹</div>
                              <div class="process-pain-point-value">${markdownToHtml(process.painPoint)}</div>
                            </div>
                          ` : ''}
                        </div>
                      </div>
                    `;
                  }).join('');
                } else {
                  return markdownToHtml(businessArchitecture);
                }
              }
              return 'æœªæå–';
            })()
          },
          {
            title: 'ä¸‰ã€è§’è‰²ä»·å€¼è½¬æ¢å±‚',
            icon: 'ğŸ‘¥',
            content: (() => {
              if (Array.isArray(data.roleValueTransformation) && data.roleValueTransformation.length > 0) {
                // å¦‚æœæ˜¯æ•°ç»„ï¼Œè½¬æ¢ä¸ºè¡¨æ ¼æˆ–åˆ—è¡¨æ ¼å¼
                let html = '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;"><thead><tr><th style="border: 1px solid #e5e7eb; padding: 8px; background: #f9fafb;">æ’åº</th><th style="border: 1px solid #e5e7eb; padding: 8px; background: #f9fafb;">è§’è‰²</th><th style="border: 1px solid #e5e7eb; padding: 8px; background: #f9fafb;">ä»·å€¼è½¬æ¢æè¿°</th><th style="border: 1px solid #e5e7eb; padding: 8px; background: #f9fafb;">è¯„åˆ†</th></tr></thead><tbody>';
                data.roleValueTransformation.forEach(item => {
                  if (typeof item === 'object' && item !== null) {
                    html += `<tr><td style="border: 1px solid #e5e7eb; padding: 8px;">${item.sort || item.æ’åº || ''}</td><td style="border: 1px solid #e5e7eb; padding: 8px;">${item.role || item.è§’è‰² || ''}</td><td style="border: 1px solid #e5e7eb; padding: 8px;">${item.description || item.ä»·å€¼è½¬æ¢æè¿° || item.desc || ''}</td><td style="border: 1px solid #e5e7eb; padding: 8px;">${item.score || item.è¯„åˆ† || ''}</td></tr>`;
                  } else if (typeof item === 'string') {
                    html += `<tr><td colspan="4" style="border: 1px solid #e5e7eb; padding: 8px;">${item}</td></tr>`;
                  }
                });
                html += '</tbody></table>';
                return html;
              } else if (typeof data.roleValueTransformation === 'string' && data.roleValueTransformation.trim()) {
                return data.roleValueTransformation;
              }
              return 'æœªæå–';
            })()
          },
          {
            title: 'å››ã€éœ€æ±‚ç—›ç‚¹å±‚',
            icon: 'âš ï¸',
            content: (data.painPoints && typeof data.painPoints === 'object' && !Array.isArray(data.painPoints) && Object.keys(data.painPoints).length > 0) ? `
              <h4>ä¸€çº¿æ‰§è¡Œå±‚ï¼ˆå…·è±¡ç—›ç‚¹ï¼‰</h4>
              ${(data.painPoints.executive && typeof data.painPoints.executive === 'string' && data.painPoints.executive.trim()) ? markdownToHtml(data.painPoints.executive) : '<p>æœªæå–</p>'}
              <h4>ä¸­é—´ç®¡ç†å±‚ï¼ˆå…·è±¡ç—›ç‚¹ï¼‰</h4>
              ${(data.painPoints.management && typeof data.painPoints.management === 'string' && data.painPoints.management.trim()) ? markdownToHtml(data.painPoints.management) : '<p>æœªæå–</p>'}
              <h4>é«˜ç®¡å±‚ï¼ˆå…·è±¡ç—›ç‚¹ï¼‰</h4>
              ${(data.painPoints.senior && typeof data.painPoints.senior === 'string' && data.painPoints.senior.trim()) ? markdownToHtml(data.painPoints.senior) : '<p>æœªæå–</p>'}
            ` : (typeof data.painPoints === 'string' ? `<p>${data.painPoints}</p>` : '<p style="color: #9ca3af; font-style: italic;">æœªæå–ï¼ˆæ•°æ®ç»“æ„ä¸ºç©ºï¼‰</p>')
          },
          {
            title: 'äº”ã€æ–¹æ¡ˆç­–ç•¥å±‚',
            icon: 'ğŸ¯',
            content: (data.solutionStrategy && typeof data.solutionStrategy === 'object' && Object.keys(data.solutionStrategy).length > 0) ? `
              <h4>5.1 ä¸»æ•°æ®è§„åˆ’</h4>
              ${(data.solutionStrategy.masterData && typeof data.solutionStrategy.masterData === 'string' && data.solutionStrategy.masterData.trim()) ? markdownToHtml(data.solutionStrategy.masterData) : '<p>æœªæå–</p>'}
              <h4>5.2 ç—›ç‚¹æ–¹æ¡ˆç½—åˆ—</h4>
              ${(data.solutionStrategy.painSolutions && typeof data.solutionStrategy.painSolutions === 'string' && data.solutionStrategy.painSolutions.trim()) ? markdownToHtml(data.solutionStrategy.painSolutions) : '<p>æœªæå–</p>'}
            ` : '<p style="color: #9ca3af; font-style: italic;">æœªæå–ï¼ˆæ•°æ®ç»“æ„ä¸ºç©ºï¼‰</p>'
          },
          {
            title: 'å…­ã€å˜é©ç®¡ç†å±‚',
            icon: 'ğŸ”„',
            content: (data.changeManagement && typeof data.changeManagement === 'string' && data.changeManagement.trim()) ? data.changeManagement : 'æœªæå–'
          },
          {
            title: 'ä¸ƒã€èµ„äº§ä¸èµ„æºè°ƒåº¦å±‚',
            icon: 'ğŸ“¦',
            content: (data.assetScheduling && typeof data.assetScheduling === 'string' && data.assetScheduling.trim()) ? data.assetScheduling : 'æœªæå–'
          },
          {
            title: 'å…«ã€è¡Œä¸šè§„èŒƒä¸æ ‡å‡†åŒ–å±‚',
            icon: 'ğŸ“',
            content: (data.standards && typeof data.standards === 'string' && data.standards.trim()) ? data.standards : 'æœªæå–'
          },
          {
            title: 'ä¹ã€è¡Œä¸šèµ„äº§æ€»ç»“',
            icon: 'ğŸ’',
            content: (data.industryAssets && typeof data.industryAssets === 'string' && data.industryAssets.trim()) ? data.industryAssets : 'æœªæå–'
          }
        ];

        sections.forEach((section, index) => {
          const sectionEl = document.createElement('div');
          sectionEl.className = 'result-section';
          
          // å¤„ç†å†…å®¹ï¼šå¦‚æœæ˜¯HTMLå­—ç¬¦ä¸²ï¼ˆåŒ…å«æ ‡ç­¾ï¼‰ï¼Œç›´æ¥ä½¿ç”¨ï¼›å¦åˆ™è½¬æ¢ä¸ºHTML
          let contentHtml = '';
          const originalContent = section.content;
          
          console.log(`[DEBUG] Section ${index + 1} (${section.title}):`, {
            originalContent: typeof originalContent,
            contentLength: typeof originalContent === 'string' ? originalContent.length : 0,
            contentPreview: typeof originalContent === 'string' ? originalContent.substring(0, 100) : originalContent
          });
          
          if (typeof originalContent === 'string') {
            const trimmed = originalContent.trim();
            // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯HTMLï¼ˆåŒ…å«æ ‡ç­¾ï¼‰
            if (trimmed.startsWith('<') || trimmed.includes('<h4>') || trimmed.includes('<p>') || trimmed.includes('<ul>')) {
              contentHtml = trimmed || '<p style="color: #9ca3af; font-style: italic;">æœªæå–</p>';
            } else if (trimmed && trimmed !== 'æœªæå–') {
              // çº¯æ–‡æœ¬ï¼Œè½¬æ¢ä¸ºHTML
              const processed = markdownToHtml(trimmed);
              contentHtml = processed || '<p style="color: #9ca3af; font-style: italic;">æœªæå–</p>';
            } else {
              contentHtml = '<p style="color: #9ca3af; font-style: italic;">æœªæå–</p>';
            }
          } else {
            contentHtml = '<p style="color: #9ca3af; font-style: italic;">æœªæå–</p>';
          }
          
          // å¦‚æœå†…å®¹ä¸ºç©ºæˆ–åªæœ‰ç©ºç™½ï¼Œæ˜¾ç¤ºæç¤º
          const finalHtml = contentHtml.trim();
          if (!finalHtml || finalHtml === '<p></p>' || finalHtml === '<p><br></p>') {
            contentHtml = '<p style="color: #9ca3af; font-style: italic;">æœªæå–</p>';
          }
          
          sectionEl.innerHTML = `
            <div class="result-section-title">
              <span>${section.icon}</span>
              <span>${section.title}</span>
            </div>
            <div class="result-section-content">
              ${contentHtml}
            </div>
          `;
          resultContainer.appendChild(sectionEl);
          
          console.log(`[DEBUG] Section ${index + 1} rendered, content length:`, contentHtml.length);
        });
        
        console.log('[DEBUG] All sections rendered, container innerHTML length:', resultContainer.innerHTML.length);
        log('info', 'render-results-done', { sectionsCount: sections.length });
        
        // å¼ºåˆ¶è§¦å‘é‡ç»˜
        resultContainer.offsetHeight;
      }

      function fillResultsFromMock() {
        // ä¿ç•™mockæ•°æ®åŠŸèƒ½ï¼Œä½†ä¸ä½¿ç”¨ï¼Œå› ä¸ºæ–°ç»“æ„å¤ªå¤æ‚
        renderResults({
          projectOverview: {
            customerName: 'ç¤ºä¾‹å®¢æˆ·',
            coreProblems: 'ç¤ºä¾‹é—®é¢˜',
            solutionSummary: 'ç¤ºä¾‹æ–¹æ¡ˆ'
          },
          businessArchitecture: 'ç¤ºä¾‹ä¸šåŠ¡æ¶æ„',
          roleValueTransformation: 'ç¤ºä¾‹è§’è‰²è½¬æ¢',
          painPoints: {
            executive: 'ç¤ºä¾‹æ‰§è¡Œå±‚ç—›ç‚¹',
            management: 'ç¤ºä¾‹ç®¡ç†å±‚ç—›ç‚¹',
            senior: 'ç¤ºä¾‹é«˜ç®¡å±‚ç—›ç‚¹'
          },
          solutionStrategy: {
            masterData: 'ç¤ºä¾‹ä¸»æ•°æ®',
            painSolutions: 'ç¤ºä¾‹è§£å†³æ–¹æ¡ˆ'
          },
          changeManagement: 'ç¤ºä¾‹å˜é©ç®¡ç†',
          assetScheduling: 'ç¤ºä¾‹èµ„æºè°ƒåº¦',
          standards: 'ç¤ºä¾‹è§„èŒƒæ ‡å‡†',
          industryAssets: 'ç¤ºä¾‹è¡Œä¸šèµ„äº§'
        });
      }

      function handleFileSelected(file) {
        if (!file) {
          log('warn', 'analyze-click-no-file');
          setStatus('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå®æ–½è“å›¾ PDF æ–‡ä»¶', true);
          return;
        }

        const sizeMb = file.size / (1024 * 1024);
        if (sizeMb > MAX_SIZE_MB) {
          log('warn', 'file-too-large', { sizeMb: sizeMb.toFixed(2) });
          setStatus('æ–‡ä»¶è¶…è¿‡ 30 MBï¼Œè¯·å‹ç¼©åé‡æ–°ä¸Šä¼ ', true);
          return;
        }

        const qwenSecret = localStorage.getItem(QWEN_SECRET_KEY);
        if (!qwenSecret) {
          log('error', 'missing-qwen-secret');
          setStatus('è¯·å…ˆåœ¨å³ä¸Šè§’é…ç½®é€šä¹‰åƒé—® Secret åå†å°è¯•è¯†åˆ«', true);
          return;
        }

        log('info', 'start-analyze', {
          fileName: file.name,
          sizeMb: sizeMb.toFixed(2),
        });

        setStatus('æ–‡ä»¶å·²ä¸Šä¼ ï¼Œæ­£åœ¨è¯†åˆ«è“å›¾å†…å®¹...', false);
        clearResults();
        setLoading(true);
        showRecognitionProcess();
        appendRecognitionProcess('å¼€å§‹è§£æ PDF æ–‡ä»¶...\n');

        const formData = new FormData();
        formData.append('file', file);

        fetch('/api/blueprint/analyze', {
          method: 'POST',
          headers: {
            'X-Qwen-Secret': qwenSecret,
          },
          body: formData,
        })
          .then(function (res) {
            if (!res.ok) {
              throw new Error('HTTP ' + res.status);
            }
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯æµå¼å“åº”
            const contentType = res.headers.get('content-type');
            if (contentType && contentType.includes('text/event-stream')) {
              // å¤„ç†æµå¼å“åº”
              return handleStreamResponse(res);
            } else {
              // å¤„ç†æ™®é€šJSONå“åº”
              return res.json().then(data => {
                return { type: 'json', data: data };
              });
            }
          })
          .then(function (result) {
            if (result.type === 'json') {
              handleJsonResponse(result.data);
            } else {
              // æµå¼å“åº”å·²åœ¨handleStreamResponseä¸­å¤„ç†
            }
          })
          .catch(function (error) {
            log('error', 'analyze-failed', { error: String(error) });
            setLoading(false);
            setStatus('è¯†åˆ«å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•æˆ–æ£€æŸ¥åç«¯æ—¥å¿—', true);
            appendRecognitionProcess('\n\nâŒ è¯†åˆ«å¤±è´¥: ' + String(error) + '\n');
            // é™çº§ï¼šä½¿ç”¨æœ¬åœ°æ¨¡æ‹Ÿç»“æœï¼Œä¿è¯æ¼”ç¤ºä½“éªŒ
            fillResultsFromMock();
          });

        function handleStreamResponse(response) {
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';
          let finalData = null;
          let hasError = false;

          function readChunk() {
            return reader.read().then(function(result) {
              if (result.done) {
                if (finalData) {
                  handleJsonResponse(finalData);
                } else if (!hasError) {
                  // å¦‚æœæ²¡æœ‰æ”¶åˆ°ç»“æœæ•°æ®ï¼Œå¯èƒ½æ˜¯é”™è¯¯
                  setLoading(false);
                  setStatus('è¯†åˆ«è¿‡ç¨‹å¼‚å¸¸ä¸­æ–­', true);
                  appendRecognitionProcess('\n\nâš ï¸ è¯†åˆ«è¿‡ç¨‹å¼‚å¸¸ä¸­æ–­ï¼Œæœªæ”¶åˆ°å®Œæ•´ç»“æœ\n');
                }
                return { type: 'stream', data: finalData };
              }

              buffer += decoder.decode(result.value, { stream: true });
              const lines = buffer.split('\n');
              buffer = lines.pop(); // ä¿ç•™æœ€åä¸€ä¸ªä¸å®Œæ•´çš„è¡Œ

              for (const line of lines) {
                if (line.trim() === '') continue;
                if (line.startsWith('data: ')) {
                  const data = line.slice(6).trim();
                  if (data === '' || data === '[DONE]') {
                    continue;
                  }
                  try {
                    const parsed = JSON.parse(data);
                    if (parsed.type === 'process') {
                      const message = typeof parsed.message === 'string' ? parsed.message : String(parsed.message || '');
                      appendRecognitionProcess(message + '\n');
                    } else if (parsed.type === 'result') {
                      log('info', 'received-result-data', { hasData: !!parsed.data, dataKeys: parsed.data ? Object.keys(parsed.data) : [] });
                      finalData = parsed.data;
                    } else if (parsed.type === 'error') {
                      hasError = true;
                      const errorMsg = typeof parsed.error === 'string' ? parsed.error : String(parsed.error || 'æœªçŸ¥é”™è¯¯');
                      setLoading(false);
                      setStatus('è¯†åˆ«å¤±è´¥: ' + errorMsg, true);
                      appendRecognitionProcess('\n\nâŒ é”™è¯¯: ' + errorMsg + '\n');
                      reader.cancel();
                      return { type: 'stream', data: null, error: errorMsg };
                    }
                  } catch (e) {
                    // å¿½ç•¥JSONè§£æé”™è¯¯ï¼Œç»§ç»­å¤„ç†
                    log('warn', 'sse-parse-error', { line: line.slice(0, 100), error: e.message });
                  }
                }
              }

              return readChunk();
            }).catch(function(error) {
              hasError = true;
              log('error', 'stream-read-error', { error: String(error) });
              setLoading(false);
              setStatus('è¯»å–è¯†åˆ«è¿‡ç¨‹å¤±è´¥: ' + error.message, true);
              appendRecognitionProcess('\n\nâŒ è¯»å–å¤±è´¥: ' + error.message + '\n');
              reader.cancel();
              throw error;
            });
          }

          return readChunk().catch(function(error) {
            // æœ€ç»ˆçš„é”™è¯¯å¤„ç†
            log('error', 'stream-handle-error', { error: String(error) });
            setLoading(false);
            setStatus('å¤„ç†è¯†åˆ«è¿‡ç¨‹æ—¶å‡ºé”™', true);
            appendRecognitionProcess('\n\nâŒ å¤„ç†é”™è¯¯: ' + error.message + '\n');
            throw error;
          });
        }

        function handleJsonResponse(data) {
          console.log('[DEBUG] handleJsonResponse called with:', data);
          log('info', 'analyze-success', { hasData: !!data, dataKeys: data ? Object.keys(data) : [] });
          setLoading(false);
          setStatus('è¯†åˆ«å®Œæˆï¼Œå·²ç”Ÿæˆè¡Œä¸šçŸ¥è¯†èµ„äº§æç‚¼ç»“æœ', false);
          appendRecognitionProcess('\nâœ… è¯†åˆ«å®Œæˆï¼\n');

          if (data) {
            try {
              console.log('[DEBUG] Calling renderResults with data:', JSON.stringify(data).substring(0, 500));
              console.log('[DEBUG] Data details:', {
                projectOverview: data.projectOverview,
                businessArchitecture: data.businessArchitecture ? data.businessArchitecture.substring(0, 100) : 'empty',
                painPoints: data.painPoints,
              });
              renderResults(data);
              log('info', 'render-results-complete');
            } catch (error) {
              console.error('[DEBUG] Error in renderResults:', error);
              log('error', 'render-results-error', { error: error.message, stack: error.stack });
              setStatus('æ¸²æŸ“ç»“æœæ—¶å‡ºé”™: ' + error.message, true);
            }
          } else {
            renderResults({
              projectOverview: { customerName: '', coreProblems: '', solutionSummary: '' },
              businessArchitecture: 'ï¼ˆåç«¯æœªè¿”å›ä¸šåŠ¡æ¶æ„ä¿¡æ¯ï¼‰',
              roleValueTransformation: 'ï¼ˆåç«¯æœªè¿”å›è§’è‰²ä»·å€¼è½¬æ¢ä¿¡æ¯ï¼‰',
              painPoints: { executive: 'ï¼ˆæœªæå–ï¼‰', management: 'ï¼ˆæœªæå–ï¼‰', senior: 'ï¼ˆæœªæå–ï¼‰' },
              solutionStrategy: { masterData: 'ï¼ˆæœªæå–ï¼‰', painSolutions: 'ï¼ˆæœªæå–ï¼‰' },
              changeManagement: 'ï¼ˆåç«¯æœªè¿”å›å˜é©ç®¡ç†ä¿¡æ¯ï¼‰',
              assetScheduling: 'ï¼ˆåç«¯æœªè¿”å›èµ„æºè°ƒåº¦ä¿¡æ¯ï¼‰',
              standards: 'ï¼ˆåç«¯æœªè¿”å›è§„èŒƒæ ‡å‡†ä¿¡æ¯ï¼‰',
              industryAssets: 'ï¼ˆåç«¯æœªè¿”å›è¡Œä¸šèµ„äº§ä¿¡æ¯ï¼‰'
            });
          }
        }
      }

      if (analyzeBtn) {
        analyzeBtn.addEventListener('click', function () {
          const file = fileInput && fileInput.files && fileInput.files[0];
          handleFileSelected(file);
        });
      }

      // å¤„ç†é¡¹ç›®èƒŒæ™¯æ¦‚è§ˆæŒ‰é’®ç‚¹å‡»
      function handleProjectOverview(file) {
        if (!file) {
          log('warn', 'project-overview-no-file');
          setStatus('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå®æ–½è“å›¾ PDF æ–‡ä»¶', true);
          return;
        }

        const sizeMb = file.size / (1024 * 1024);
        if (sizeMb > MAX_SIZE_MB) {
          log('warn', 'file-too-large', { sizeMb: sizeMb.toFixed(2) });
          setStatus('æ–‡ä»¶è¶…è¿‡ 30 MBï¼Œè¯·å‹ç¼©åé‡æ–°ä¸Šä¼ ', true);
          return;
        }

        const qwenSecret = localStorage.getItem(QWEN_SECRET_KEY);
        if (!qwenSecret) {
          log('error', 'missing-qwen-secret');
          setStatus('è¯·å…ˆåœ¨å³ä¸Šè§’é…ç½®é€šä¹‰åƒé—® Secret åå†å°è¯•è¯†åˆ«', true);
          return;
        }

        log('info', 'start-project-overview', {
          fileName: file.name,
          sizeMb: sizeMb.toFixed(2),
        });

        setStatus('æ­£åœ¨æå–é¡¹ç›®èƒŒæ™¯æ¦‚è§ˆ...', false);
        if (projectOverviewBtn) {
          projectOverviewBtn.disabled = true;
          const span = projectOverviewBtn.querySelector('span');
          if (span) span.textContent = 'æå–ä¸­...';
        }
        showRecognitionProcess();
        appendRecognitionProcess('å¼€å§‹æå–é¡¹ç›®èƒŒæ™¯æ¦‚è§ˆ...\n');

        const formData = new FormData();
        formData.append('file', file);

        fetch('/api/blueprint/project-overview', {
          method: 'POST',
          headers: {
            'X-Qwen-Secret': qwenSecret,
          },
          body: formData,
        })
          .then(function (res) {
            if (!res.ok) {
              throw new Error('HTTP ' + res.status);
            }
            return res.json();
          })
          .then(function (data) {
            log('info', 'project-overview-success');
            if (projectOverviewBtn) {
              projectOverviewBtn.disabled = false;
              const span = projectOverviewBtn.querySelector('span');
              if (span) span.textContent = 'é¡¹ç›®èƒŒæ™¯æ¦‚è§ˆ';
            }
            setStatus('é¡¹ç›®èƒŒæ™¯æ¦‚è§ˆæå–å®Œæˆ', false);
            appendRecognitionProcess('\nâœ… æå–å®Œæˆï¼\n');
            
            // æ˜¾ç¤ºé¡¹ç›®èƒŒæ™¯æ¦‚è§ˆç»“æœ
            renderProjectOverview(data);
          })
          .catch(function (error) {
            log('error', 'project-overview-failed', { error: String(error) });
            if (projectOverviewBtn) {
              projectOverviewBtn.disabled = false;
              const span = projectOverviewBtn.querySelector('span');
              if (span) span.textContent = 'é¡¹ç›®èƒŒæ™¯æ¦‚è§ˆ';
            }
            setStatus('æå–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', true);
            appendRecognitionProcess('\n\nâŒ æå–å¤±è´¥: ' + String(error) + '\n');
          });
      }

      // æ¸²æŸ“é¡¹ç›®èƒŒæ™¯æ¦‚è§ˆç»“æœ
      function renderProjectOverview(data) {
        if (!resultContainer || !resultPlaceholder) return;
        
        if (resultPlaceholder) {
          resultPlaceholder.style.display = 'none';
        }
        resultContainer.style.display = 'block';
        resultContainer.innerHTML = '';

        const sectionEl = document.createElement('div');
        sectionEl.className = 'result-section';
        
        let contentHtml = '';
        if (data && typeof data === 'object') {
          const customerName = (data.customerName && data.customerName.trim()) || 'æœªæå–';
          const coreProblems = (data.coreProblems && data.coreProblems.trim()) || 'æœªæå–';
          const solutionSummary = (data.solutionSummary && data.solutionSummary.trim()) || 'æœªæå–';
          
          contentHtml = `
            <h4>å®¢æˆ·åç§°</h4>
            <p>${customerName}</p>
            <h4>æ ¸å¿ƒé—®é¢˜</h4>
            ${markdownToHtml(coreProblems)}
            <h4>è§£å†³æ–¹æ¡ˆå°ç»“</h4>
            ${markdownToHtml(solutionSummary)}
          `;
        } else {
          contentHtml = '<p style="color: #9ca3af; font-style: italic;">æœªæå–</p>';
        }
        
        sectionEl.innerHTML = `
          <div class="result-section-title">
            <span>ğŸ“‹</span>
            <span>é¡¹ç›®èƒŒæ™¯æ¦‚è§ˆ</span>
          </div>
          <div class="result-section-content">
            ${contentHtml}
          </div>
        `;
        resultContainer.appendChild(sectionEl);
      }

      // é€šç”¨æå–å‡½æ•°
      function handleExtract(file, endpoint, buttonId, buttonText, sectionTitle, sectionIcon, renderFn) {
        if (!file) {
          log('warn', 'no-file', { endpoint });
          setStatus('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå®æ–½è“å›¾ PDF æ–‡ä»¶', true);
          return;
        }

        const qwenSecret = localStorage.getItem(QWEN_SECRET_KEY);
        if (!qwenSecret) {
          log('error', 'missing-qwen-secret');
          setStatus('è¯·å…ˆåœ¨å³ä¸Šè§’é…ç½®é€šä¹‰åƒé—® Secret åå†å°è¯•æå–', true);
          return;
        }

        const sizeMb = file.size / (1024 * 1024);
        if (sizeMb > 50) {
          setStatus('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 50MB', true);
          return;
        }

        log('info', 'start-extract', { endpoint, fileName: file.name, sizeMb: sizeMb.toFixed(2) });
        setStatus('æ­£åœ¨æå–...', false);
        const btn = document.getElementById(buttonId);
        if (btn) {
          btn.disabled = true;
          const span = btn.querySelector('span');
          if (span) span.textContent = 'æå–ä¸­...';
        }
        showRecognitionProcess();
        appendRecognitionProcess(`å¼€å§‹æå–${sectionTitle}...\n`);

        const formData = new FormData();
        formData.append('file', file);

        fetch(endpoint, {
          method: 'POST',
          headers: {
            'X-Qwen-Secret': qwenSecret,
          },
          body: formData,
        })
          .then(function (res) {
            if (!res.ok) {
              throw new Error('HTTP ' + res.status);
            }
            return res.json();
          })
          .then(function (data) {
            log('info', 'extract-success', { endpoint, data });
            setStatus(`${sectionTitle}æå–å®Œæˆ`, false);
            appendRecognitionProcess(`\nâœ… ${sectionTitle}æå–å®Œæˆï¼\n`);
            renderFn(data);
          })
          .catch(function (error) {
            log('error', 'extract-failed', { endpoint, error: String(error) });
            setStatus('æå–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', true);
            appendRecognitionProcess(`\n\nâŒ æå–å¤±è´¥: ${String(error)}\n`);
          })
          .finally(function () {
            if (btn) {
              btn.disabled = false;
              const span = btn.querySelector('span');
              if (span) span.textContent = buttonText.replace(/^\+/, '');
            }
          });
      }

      // æ¸²æŸ“é€šç”¨å‡½æ•°
      function renderSection(data, sectionTitle, sectionIcon, contentKey, contentFn) {
        if (!resultContainer || !resultPlaceholder) return;
        
        if (resultPlaceholder) {
          resultPlaceholder.style.display = 'none';
        }
        resultContainer.style.display = 'block';
        
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥sectionï¼Œå¦‚æœå­˜åœ¨åˆ™æ›´æ–°ï¼Œå¦åˆ™è¿½åŠ 
        let sectionEl = Array.from(resultContainer.children).find(el => 
          el.querySelector('.result-section-title') && 
          el.querySelector('.result-section-title').textContent.includes(sectionTitle)
        );
        
        if (!sectionEl) {
          sectionEl = document.createElement('div');
          sectionEl.className = 'result-section';
          resultContainer.appendChild(sectionEl);
        }
        
        let contentHtml = '';
        if (data && typeof data === 'object') {
          if (contentFn) {
            contentHtml = contentFn(data);
          } else if (contentKey) {
            const content = data[contentKey] || '';
            contentHtml = markdownToHtml(content);
          }
        } else {
          contentHtml = '<p style="color: #9ca3af; font-style: italic;">æœªæå–</p>';
        }
        
        sectionEl.innerHTML = `
          <div class="result-section-title">
            <span>${sectionIcon}</span>
            <span>${sectionTitle}</span>
          </div>
          <div class="result-section-content">
            ${contentHtml}
          </div>
        `;
      }

      // ä¸šåŠ¡æ¶æ„å±‚
      function renderBusinessArchitecture(data) {
        if (!resultContainer || !resultPlaceholder) return;
        
        if (resultPlaceholder) {
          resultPlaceholder.style.display = 'none';
        }
        resultContainer.style.display = 'block';
        
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥sectionï¼Œå¦‚æœå­˜åœ¨åˆ™æ›´æ–°ï¼Œå¦åˆ™è¿½åŠ 
        let sectionEl = Array.from(resultContainer.children).find(el => 
          el.querySelector('.result-section-title') && 
          el.querySelector('.result-section-title').textContent.includes('ä¸šåŠ¡æ¶æ„å±‚')
        );
        
        if (!sectionEl) {
          sectionEl = document.createElement('div');
          sectionEl.className = 'result-section';
          resultContainer.appendChild(sectionEl);
        }
        
        let contentHtml = '';
        const businessArchitecture = data && data.businessArchitecture;
        
        if (businessArchitecture && typeof businessArchitecture === 'string' && businessArchitecture.trim()) {
          const processes = parseBusinessArchitecture(businessArchitecture);
          console.log('[DEBUG] Parsed processes:', processes);
          
          if (processes.length > 0) {
            contentHtml = processes.map((process, index) => {
              const processId = `process-${index}`;
              console.log(`[DEBUG] Process ${index}:`, process);
              
              // å¦‚æœstepsä¸ºç©ºï¼Œå°è¯•ä½¿ç”¨æµç¨‹çº§åˆ«çš„å­—æ®µåˆ›å»ºä¸€ä¸ªé»˜è®¤ç¯èŠ‚
              if (!process.steps || process.steps.length === 0) {
                // æ£€æŸ¥æ˜¯å¦æœ‰æµç¨‹çº§åˆ«çš„å­—æ®µï¼Œå¦‚æœæœ‰ï¼Œåˆ›å»ºä¸€ä¸ªé»˜è®¤ç¯èŠ‚
                const hasProcessFields = process.stepName || process.role || process.workContent;
                if (hasProcessFields) {
                  process.steps = [{
                    stepName: process.stepName || '',
                    role: process.role || '',
                    workContent: process.workContent || ''
                  }];
                }
              }
              
              // æ¸²æŸ“ç¯èŠ‚åˆ—è¡¨
              const stepsHtml = process.steps && process.steps.length > 0 ? process.steps.map((step, stepIndex) => {
                return `
                  <div class="process-step">
                    ${step.stepName ? `
                      <div class="process-step-item">
                        <div class="process-step-label">ç¯èŠ‚åç§°</div>
                        <div class="process-step-value">${step.stepName}</div>
                      </div>
                    ` : ''}
                    ${step.role ? `
                      <div class="process-step-item">
                        <div class="process-step-label">æ‰§è¡Œè§’è‰²</div>
                        <div class="process-step-value">${step.role}</div>
                      </div>
                    ` : ''}
                    ${step.workContent ? `
                      <div class="process-step-item">
                        <div class="process-step-label">å·¥ä½œå†…å®¹</div>
                        <div class="process-step-value">${markdownToHtml(step.workContent)}</div>
                      </div>
                    ` : ''}
                  </div>
                `;
              }).join('') : '<p style="color: #9ca3af; font-style: italic; padding-left: 20px;">æš‚æ— ç¯èŠ‚ä¿¡æ¯</p>';
              
              return `
                <div class="process-card" id="${processId}">
                  <div class="process-card-header" onclick="this.parentElement.classList.toggle('expanded')">
                    <div class="process-card-title">æµç¨‹ ${process.number} ${process.name}</div>
                    <div class="process-card-toggle">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 9l6 6 6-6"/>
                      </svg>
                    </div>
                  </div>
                  <div class="process-card-content">
                    ${stepsHtml}
                    ${process.transitionCondition ? `
                      <div class="process-field" style="margin-top: 16px;">
                        <div class="process-field-label">æµè½¬æ¡ä»¶</div>
                        <div class="process-field-value">${process.transitionCondition}</div>
                      </div>
                    ` : ''}
                    ${process.painPoint ? `
                      <div class="process-pain-point" style="margin-top: 16px;">
                        <div class="process-pain-point-label">æ½œåœ¨ç—›ç‚¹</div>
                        <div class="process-pain-point-value">${markdownToHtml(process.painPoint)}</div>
                      </div>
                    ` : ''}
                  </div>
                </div>
              `;
            }).join('');
          } else {
            // å¦‚æœè§£æå¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æ–‡æœ¬
            contentHtml = markdownToHtml(businessArchitecture);
          }
        } else {
          contentHtml = '<p style="color: #9ca3af; font-style: italic;">æœªæå–</p>';
        }
        
        sectionEl.innerHTML = `
          <div class="result-section-title">
            <span>ğŸ—ï¸</span>
            <span>äºŒã€ä¸šåŠ¡æ¶æ„å±‚ (å…¨é‡æµç¨‹æ·±åº¦æ‹†è§£)</span>
          </div>
          <div class="result-section-content">
            ${contentHtml}
          </div>
        `;
      }

      // è§’è‰²ä»·å€¼è½¬æ¢å±‚
      function renderRoleValueTransformation(data) {
        renderSection(data, 'ä¸‰ã€è§’è‰²ä»·å€¼è½¬æ¢å±‚', 'ğŸ‘¥', 'roleValueTransformation');
      }

      // éœ€æ±‚ç—›ç‚¹å±‚
      function renderPainPoints(data) {
        const contentFn = (data) => {
          const executive = (data.executive && data.executive.trim()) || 'æœªæå–';
          const management = (data.management && data.management.trim()) || 'æœªæå–';
          const senior = (data.senior && data.senior.trim()) || 'æœªæå–';
          return `
            <h4>ä¸€çº¿æ‰§è¡Œå±‚ï¼ˆå…·è±¡ç—›ç‚¹ï¼‰</h4>
            ${markdownToHtml(executive)}
            <h4>ä¸­é—´ç®¡ç†å±‚ï¼ˆå…·è±¡ç—›ç‚¹ï¼‰</h4>
            ${markdownToHtml(management)}
            <h4>é«˜ç®¡å±‚ï¼ˆå…·è±¡ç—›ç‚¹ï¼‰</h4>
            ${markdownToHtml(senior)}
          `;
        };
        renderSection(data, 'å››ã€éœ€æ±‚ç—›ç‚¹å±‚', 'âš ï¸', null, contentFn);
      }

      // IT æ¶æ„ä¸é›†æˆå±‚
      function renderItArchitecture(data) {
        renderSection(data, 'IT æ¶æ„ä¸é›†æˆå±‚', 'ğŸ’»', 'itArchitecture');
      }

      // æ–¹æ¡ˆç­–ç•¥å±‚
      function renderSolutionStrategy(data) {
        const contentFn = (data) => {
          const masterData = (data.masterData && data.masterData.trim()) || 'æœªæå–';
          const painSolutions = (data.painSolutions && data.painSolutions.trim()) || 'æœªæå–';
          return `
            <h4>5.1 ä¸»æ•°æ®è§„åˆ’</h4>
            ${markdownToHtml(masterData)}
            <h4>5.2 ç—›ç‚¹æ–¹æ¡ˆç½—åˆ—</h4>
            ${markdownToHtml(painSolutions)}
          `;
        };
        renderSection(data, 'äº”ã€æ–¹æ¡ˆç­–ç•¥å±‚', 'ğŸ’¡', null, contentFn);
      }

      // å˜é©ç®¡ç†å±‚
      function renderChangeManagement(data) {
        renderSection(data, 'å…­ã€å˜é©ç®¡ç†å±‚', 'ğŸ”„', 'changeManagement');
      }

      // èµ„äº§ä¸èµ„æºè°ƒåº¦å±‚
      function renderAssetScheduling(data) {
        renderSection(data, 'ä¸ƒã€èµ„äº§ä¸èµ„æºè°ƒåº¦å±‚', 'ğŸ“¦', 'assetScheduling');
      }

      // è¡Œä¸šè§„èŒƒä¸æ ‡å‡†åŒ–å±‚
      function renderStandards(data) {
        renderSection(data, 'å…«ã€è¡Œä¸šè§„èŒƒä¸æ ‡å‡†åŒ–å±‚', 'ğŸ“', 'standards');
      }

      // è¡Œä¸šèµ„äº§æ€»ç»“å±‚
      function renderIndustryAssets(data) {
        renderSection(data, 'ä¹ã€è¡Œä¸šèµ„äº§æ€»ç»“å±‚', 'â­', 'industryAssets');
      }

      // æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
      if (projectOverviewBtn) {
        projectOverviewBtn.addEventListener('click', function () {
          const file = fileInput && fileInput.files && fileInput.files[0];
          handleProjectOverview(file);
        });
      }

      const businessArchitectureBtn = document.getElementById('businessArchitectureBtn');
      if (businessArchitectureBtn) {
        businessArchitectureBtn.addEventListener('click', function () {
          const file = fileInput && fileInput.files && fileInput.files[0];
          handleExtract(file, '/api/blueprint/business-architecture', 'businessArchitectureBtn', 'ä¸šåŠ¡æ¶æ„å±‚', 'ä¸šåŠ¡æ¶æ„å±‚', 'ğŸ—ï¸', renderBusinessArchitecture);
        });
      }

      const roleValueTransformationBtn = document.getElementById('roleValueTransformationBtn');
      if (roleValueTransformationBtn) {
        roleValueTransformationBtn.addEventListener('click', function () {
          const file = fileInput && fileInput.files && fileInput.files[0];
          handleExtract(file, '/api/blueprint/role-value-transformation', 'roleValueTransformationBtn', 'è§’è‰²ä»·å€¼è½¬æ¢å±‚', 'è§’è‰²ä»·å€¼è½¬æ¢å±‚', 'ğŸ‘¥', renderRoleValueTransformation);
        });
      }

      const painPointsBtn = document.getElementById('painPointsBtn');
      if (painPointsBtn) {
        painPointsBtn.addEventListener('click', function () {
          const file = fileInput && fileInput.files && fileInput.files[0];
          handleExtract(file, '/api/blueprint/pain-points', 'painPointsBtn', 'éœ€æ±‚ç—›ç‚¹å±‚', 'éœ€æ±‚ç—›ç‚¹å±‚', 'âš ï¸', renderPainPoints);
        });
      }

      const itArchitectureBtn = document.getElementById('itArchitectureBtn');
      if (itArchitectureBtn) {
        itArchitectureBtn.addEventListener('click', function () {
          const file = fileInput && fileInput.files && fileInput.files[0];
          handleExtract(file, '/api/blueprint/it-architecture', 'itArchitectureBtn', 'IT æ¶æ„ä¸é›†æˆå±‚', 'IT æ¶æ„ä¸é›†æˆå±‚', 'ğŸ’»', renderItArchitecture);
        });
      }

      const solutionStrategyBtn = document.getElementById('solutionStrategyBtn');
      if (solutionStrategyBtn) {
        solutionStrategyBtn.addEventListener('click', function () {
          const file = fileInput && fileInput.files && fileInput.files[0];
          handleExtract(file, '/api/blueprint/solution-strategy', 'solutionStrategyBtn', 'æ–¹æ¡ˆç­–ç•¥å±‚', 'æ–¹æ¡ˆç­–ç•¥å±‚', 'ğŸ’¡', renderSolutionStrategy);
        });
      }

      const changeManagementBtn = document.getElementById('changeManagementBtn');
      if (changeManagementBtn) {
        changeManagementBtn.addEventListener('click', function () {
          const file = fileInput && fileInput.files && fileInput.files[0];
          handleExtract(file, '/api/blueprint/change-management', 'changeManagementBtn', 'å˜é©ç®¡ç†å±‚', 'å˜é©ç®¡ç†å±‚', 'ğŸ”„', renderChangeManagement);
        });
      }

      const assetSchedulingBtn = document.getElementById('assetSchedulingBtn');
      if (assetSchedulingBtn) {
        assetSchedulingBtn.addEventListener('click', function () {
          const file = fileInput && fileInput.files && fileInput.files[0];
          handleExtract(file, '/api/blueprint/asset-scheduling', 'assetSchedulingBtn', 'èµ„äº§ä¸èµ„æºè°ƒåº¦å±‚', 'èµ„äº§ä¸èµ„æºè°ƒåº¦å±‚', 'ğŸ“¦', renderAssetScheduling);
        });
      }

      const standardsBtn = document.getElementById('standardsBtn');
      if (standardsBtn) {
        standardsBtn.addEventListener('click', function () {
          const file = fileInput && fileInput.files && fileInput.files[0];
          handleExtract(file, '/api/blueprint/standards', 'standardsBtn', 'è¡Œä¸šè§„èŒƒä¸æ ‡å‡†åŒ–å±‚', 'è¡Œä¸šè§„èŒƒä¸æ ‡å‡†åŒ–å±‚', 'ğŸ“', renderStandards);
        });
      }

      const industryAssetsBtn = document.getElementById('industryAssetsBtn');
      if (industryAssetsBtn) {
        industryAssetsBtn.addEventListener('click', function () {
          const file = fileInput && fileInput.files && fileInput.files[0];
          handleExtract(file, '/api/blueprint/industry-assets', 'industryAssetsBtn', 'è¡Œä¸šèµ„äº§æ€»ç»“å±‚', 'è¡Œä¸šèµ„äº§æ€»ç»“å±‚', 'â­', renderIndustryAssets);
        });
      }

      if (uploadArea && fileInput) {
        uploadArea.addEventListener('click', function (event) {
          // é¿å…ç‚¹å‡»æŒ‰é’®æ—¶åˆå¼¹å‡ºé€‰æ‹©æ¡†
          if (event.target.tagName === 'BUTTON' || event.target.closest('button')) return;
          fileInput.click();
        });

        uploadArea.addEventListener('dragover', function (event) {
          event.preventDefault();
          uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', function (event) {
          event.preventDefault();
          uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', function (event) {
          event.preventDefault();
          uploadArea.classList.remove('dragover');
          const file = event.dataTransfer && event.dataTransfer.files && event.dataTransfer.files[0];
          if (file) {
            if (file.type !== 'application/pdf') {
              setStatus('è¯·ä¸Šä¼  PDF æ ¼å¼çš„æ–‡ä»¶', true);
              return;
            }
            if (fileInput) {
              // åˆ›å»ºä¸€ä¸ªæ–°çš„FileListå¯¹è±¡æ¥è®¾ç½®æ–‡ä»¶
              const dataTransfer = new DataTransfer();
              dataTransfer.items.add(file);
              fileInput.files = dataTransfer.files;
            }
            showFileName(file.name);
            setStatus('æ–‡ä»¶å·²é€‰æ‹©ï¼Œç‚¹å‡»"å¼€å§‹è¯†åˆ«"æŒ‰é’®è¿›è¡Œåˆ†æ', false);
          }
        });

        // ç›‘å¬æ–‡ä»¶é€‰æ‹©äº‹ä»¶
        if (fileInput) {
          fileInput.addEventListener('change', function(event) {
            const file = event.target.files && event.target.files[0];
            if (file) {
              showFileName(file.name);
            } else {
              hideFileName();
            }
          });
        }
      }

      // é€šä¹‰åƒé—® Secret é…ç½®é€»è¾‘
      function openQwenModal() {
        if (!qwenModalBackdrop) return;
        qwenModalBackdrop.classList.add('show');
        const saved = localStorage.getItem(QWEN_SECRET_KEY);
        if (qwenSecretInput) {
          qwenSecretInput.value = saved || '';
        }
        if (qwenConfigStatus) {
          qwenConfigStatus.textContent = saved ? `å·²åŠ è½½é…ç½®ï¼š${maskSecret(saved)}` : '';
        }
      }

      function closeQwenModal() {
        if (!qwenModalBackdrop) return;
        qwenModalBackdrop.classList.remove('show');
      }

      if (openQwenBtn) {
        openQwenBtn.addEventListener('click', function () {
          openQwenModal();
        });
      }
      if (openQwenIcon) {
        openQwenIcon.addEventListener('click', function () {
          openQwenModal();
        });
      }
      if (closeQwenBtn) {
        closeQwenBtn.addEventListener('click', function () {
          closeQwenModal();
        });
      }
      if (qwenModalBackdrop) {
        qwenModalBackdrop.addEventListener('click', function (event) {
          if (event.target === qwenModalBackdrop) {
            closeQwenModal();
          }
        });
      }
      if (saveQwenBtn && qwenSecretInput && qwenConfigStatus) {
        saveQwenBtn.addEventListener('click', function () {
          const value = qwenSecretInput.value.trim();
          if (!value) {
            qwenConfigStatus.style.color = '#dc2626';
            qwenConfigStatus.textContent = 'Secret ä¸èƒ½ä¸ºç©º';
            return;
          }
          localStorage.setItem(QWEN_SECRET_KEY, value);
          qwenConfigStatus.style.color = '#059669';
          qwenConfigStatus.textContent = `å·²ä¿å­˜ï¼š${maskSecret(value)}`;
        });
      }
      if (clearQwenBtn && qwenSecretInput && qwenConfigStatus) {
        clearQwenBtn.addEventListener('click', function () {
          localStorage.removeItem(QWEN_SECRET_KEY);
          qwenSecretInput.value = '';
          qwenConfigStatus.style.color = '#6b7280';
          qwenConfigStatus.textContent = 'å·²æ¸…é™¤æœ¬åœ°é…ç½®';
        });
      }
    })();
  </script>
</body>
</html>